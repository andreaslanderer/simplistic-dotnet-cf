AWSTemplateFormatVersion: "2010-09-09"

Parameters:
    VPC:
      Type: "AWS::EC2::VPC::Id"
  
    Subnets:
      Type: "List<AWS::EC2::Subnet::Id>"

Resources:
  MyRDSInstanceRotationSecret:
    Type: "AWS::SecretsManager::Secret"
    Properties:
      Description: 'This is the secret for my RDS instance'
      GenerateSecretString:
        SecretStringTemplate: '{"username": "admin"}'
        GenerateStringKey: 'password'
        PasswordLength: 16
        ExcludeCharacters: '"@/\'

  ConnectionStringSecret:
    Type: "AWS::SecretsManager::Secret"
    Properties:
      SecretString: !Join ['', ['Server=', !GetAtt MyDBInstance.Endpoint.Address, ';Database=tempdb;User Id=', '{{resolve:secretsmanager:', !Ref MyRDSInstanceRotationSecret, ':SecretString:username}}', ";Password='", '{{resolve:secretsmanager:', !Ref MyRDSInstanceRotationSecret, ':SecretString:password}}', "'" ]]
  
  MyDBInstance:
      Type: AWS::RDS::DBInstance
      Properties:
         AllocatedStorage: 20
         DBInstanceClass: db.t2.small
         Engine: sqlserver-web
         EngineVersion: 14.00.3223.3.v1
         LicenseModel: license-included
         MasterUsername: !Join ['', ['{{resolve:secretsmanager:', !Ref MyRDSInstanceRotationSecret, ':SecretString:username}}' ]]
         MasterUserPassword: !Join ['', ['{{resolve:secretsmanager:', !Ref MyRDSInstanceRotationSecret, ':SecretString:password}}' ]]
         BackupRetentionPeriod: 0
         DBSubnetGroupName: !Ref DBSubnetGroup
         VPCSecurityGroups: 
           - !Ref DatabaseSG

  DBSubnetGroup:
    Type: "AWS::RDS::DBSubnetGroup"
    Properties:
      DBSubnetGroupDescription: db subnet group
      SubnetIds: !Ref Subnets

  DatabaseSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: SQLServer
      SecurityGroupIngress:
        - FromPort: 1433
          IpProtocol: tcp
          ##SourceSecurityGroupId: !GetAtt ApplicationSG.GroupId
          CidrIp: "0.0.0.0/0" #FIXME
          ToPort: 1433
      VpcId: !Ref VPC

  SecretRDSInstanceAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref MyRDSInstanceRotationSecret
      TargetId: !Ref MyDBInstance
      TargetType: AWS::RDS::DBInstance

Outputs:
  DBAddress:
    Value: !GetAtt MyDBInstance.Endpoint.Address
  
  ConnectionStringSecret:
     Value: !Ref ConnectionStringSecret
